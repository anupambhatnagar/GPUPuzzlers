---
layout: post
title: The Faster Way to Add?
permalink: /posts/faster-way-to-add/
excerpt: This puzzle presents three different ways to add elements of a tensor. Can you figure out the fastest implementation?
---

The code snippet below sums up the elements in a 1D tensor in three different ways. Which
implementation is the fastest, which one is the slowest and why?

``` python
import torch
from torch.profiler import profile, tensorboard_trace_handler, ProfilerActivity

def first_sum(a_tensor):
    total = 0.0
    for i in range(a_tensor.size()[0]):
        total += a_tensor[i].cpu()
    return total

def second_sum(a_tensor):
    total = torch.zeros(1, device='cuda')
    for i in range(a_tensor.size()[0]):
        total += a_tensor[i]
    return total

def third_sum(a_tensor):
    total = 0.0
    tensor_on_cpu = a_tensor.cpu()
    for i in range(tensor_on_cpu.size()[0]):
        total += tensor_on_cpu[i]
    return total

torch.manual_seed(145) # Fun fact: 145 = 1! + 4! + 5! (exclamation = factorial)
data = torch.rand(2**12, device='cuda')

sum1 = first_sum(data)
sum2 = second_sum(data)
sum3 = third_sum(data)

trace_handler = tensorboard_trace_handler(dir_name="./d2h_sync_trace", use_gzip=True)
with profile(activities = [ProfilerActivity.CPU, ProfilerActivity.CUDA],
             on_trace_ready = trace_handler,
             record_shapes = True,
             with_stack = True
) as prof:

    sum1 = first_sum(tensor)
    sum2 = second_sum(tensor)
    sum3 = third_sum(tensor)
    sum4 = torch.sum(tensor)
    cpu_tensor = torch.rand(2**12, device = 'cpu')
    sum5 = torch.sum(cpu_tensor)
```

[See answer and discussion](/faster-way-to-add-answer)
